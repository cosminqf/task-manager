@model List<TaskManager.Models.ProjectTask>

@{
    ViewData["Title"] = "Dashboard";
    var notStartedTasks = Model?.Where(t => t.Status == TaskManager.Models.TaskStatus.NotStarted).ToList() ?? new List<TaskManager.Models.ProjectTask>();
    var inProgressTasks = Model?.Where(t => t.Status == TaskManager.Models.TaskStatus.InProgress).ToList() ?? new List<TaskManager.Models.ProjectTask>();
    var completedTasks = Model?.Where(t => t.Status == TaskManager.Models.TaskStatus.Completed).ToList() ?? new List<TaskManager.Models.ProjectTask>();
}

@section Styles {
    <link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
}

<div class="container mt-5 mb-5">
    <div class="dashboard-header mb-xl">
        <div class="d-flex justify-content-between align-items-center mb-md">
            <div>
                <h1 class="mb-sm">👋 Salut, @User.Identity?.Name!</h1>
                <p class="lead text-muted mb-0">Ai o privire de ansamblu asupra activității tale.</p>
            </div>
            <a asp-controller="Projects" asp-action="Index" class="btn btn-primary">
                <i class="bi bi-folder-plus"></i> Proiect Nou
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-xl">
        <div class="col-md-6 col-lg-3">
            <div class="stat-card dashboard-card">
                <span class="stat-number">@ViewBag.TotalTasks</span>
                <span class="stat-label">
                    <i class="bi bi-list-task"></i> Total Task-uri
                </span>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="stat-card dashboard-card">
                <span class="stat-number" style="color: var(--color-warning);">@ViewBag.ActiveTasks</span>
                <span class="stat-label">
                    <i class="bi bi-hourglass-split"></i> Active
                </span>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="stat-card dashboard-card">
                <span class="stat-number" style="color: var(--color-success);">@ViewBag.CompletedTasks</span>
                <span class="stat-label">
                    <i class="bi bi-check-circle"></i> Finalizate
                </span>
            </div>
        </div>

        <div class="col-md-6 col-lg-3">
            <div class="stat-card dashboard-card">
                <span class="stat-number" style="color: var(--color-danger);">@ViewBag.UrgentTasks</span>
                <span class="stat-label">
                    <i class="bi bi-exclamation-triangle"></i> Urgente
                </span>
            </div>
        </div>
    </div>



    @if (Model == null || Model.Count == 0)
    {
        ViewBag.Icon = "📋";
        ViewBag.Title = "Nu ai task-uri atribuite";
        ViewBag.Description = "Momentan nu există task-uri atribuite ție. Verifică proiectele tale pentru a vedea task-urile disponibile.";
        ViewBag.ActionText = "Vezi Proiectele";
        ViewBag.ActionUrl = Url.Action("Index", "Projects");
        
        <partial name="_EmptyState" />
    }
    else
    {
        <!-- Kanban Board View -->
        <div class="kanban-board mb-xl">
            <!-- Not Started Column -->
            <div class="kanban-column">
                <div class="kanban-column-header">
                    <span><i class="bi bi-circle"></i> Neîncepute</span>
                    <span class="kanban-count">@notStartedTasks.Count</span>
                </div>
                @if (!notStartedTasks.Any())
                {
                    <div class="empty-state p-md">
                        <div class="empty-state-icon" style="font-size: 2rem;">📝</div>
                        <p class="text-muted small mb-0">Niciun task</p>
                    </div>
                }
                else
                {
                    @foreach (var task in notStartedTasks.Take(5))
                    {
                        <div class="mb-md">
                            <partial name="_TaskCard" model="task" />
                        </div>
                    }
                    @if (notStartedTasks.Count > 5)
                    {
                        <p class="text-center text-muted small">+@(notStartedTasks.Count - 5) mai multe</p>
                    }
                }
            </div>

            <!-- In Progress Column -->
            <div class="kanban-column">
                <div class="kanban-column-header">
                    <span><i class="bi bi-hourglass-split"></i> În Progres</span>
                    <span class="kanban-count">@inProgressTasks.Count</span>
                </div>
                @if (!inProgressTasks.Any())
                {
                    <div class="empty-state p-md">
                        <div class="empty-state-icon" style="font-size: 2rem;">⏳</div>
                        <p class="text-muted small mb-0">Niciun task</p>
                    </div>
                }
                else
                {
                    @foreach (var task in inProgressTasks.Take(5))
                    {
                        <div class="mb-md">
                            <partial name="_TaskCard" model="task" />
                        </div>
                    }
                    @if (inProgressTasks.Count > 5)
                    {
                        <p class="text-center text-muted small">+@(inProgressTasks.Count - 5) mai multe</p>
                    }
                }
            </div>

            <!-- Completed Column -->
            <div class="kanban-column">
                <div class="kanban-column-header">
                    <span><i class="bi bi-check-circle"></i> Finalizate</span>
                    <span class="kanban-count">@completedTasks.Count</span>
                </div>
                @if (!completedTasks.Any())
                {
                    <div class="empty-state p-md">
                        <div class="empty-state-icon" style="font-size: 2rem;">✅</div>
                        <p class="text-muted small mb-0">Niciun task</p>
                    </div>
                }
                else
                {
                    @foreach (var task in completedTasks.Take(5))
                    {
                        <div class="mb-md">
                            <partial name="_TaskCard" model="task" />
                        </div>
                    }
                    @if (completedTasks.Count > 5)
                    {
                        <p class="text-center text-muted small">+@(completedTasks.Count - 5) mai multe</p>
                    }
                }
            </div>
        </div>
    }
    
    <!-- Deadline-uri Apropiate -->
    @if (Model != null && Model.Any())
    {
        var upcomingTasks = Model.Where(t => 
            t.Status != TaskManager.Models.TaskStatus.Completed && 
            t.EndDate >= DateTime.Now && 
            t.EndDate <= DateTime.Now.AddDays(7))
            .OrderBy(t => t.EndDate)
            .Take(5)
            .ToList();
        
        if (upcomingTasks.Any())
        {
            <div class="card mb-lg">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Deadline-uri Apropiate (următoarele 7 zile)</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        @foreach (var task in upcomingTasks)
                        {
                            var daysUntil = (task.EndDate - DateTime.Now).Days;
                            var isUrgent = daysUntil <= 2;
                            
                            <div class="list-group-item px-0 border-start-0 border-end-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <a asp-controller="Tasks" asp-action="Show" asp-route-id="@task.Id" class="text-decoration-none">
                                            <strong>@task.Title</strong>
                                        </a>
                                        <div class="small text-muted">
                                            @task.Project?.Title
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <partial name="_StatusBadge" model="task.Status" />
                                        <div class="@(isUrgent ? "text-danger fw-bold" : "text-muted") small mt-1">
                                            <i class="bi bi-calendar"></i>
                                            @if (daysUntil == 0)
                                            {
                                                <span>Astăzi</span>
                                            }
                                            else if (daysUntil == 1)
                                            {
                                                <span>Mâine</span>
                                            }
                                            else
                                            {
                                                <span>În @daysUntil zile</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>