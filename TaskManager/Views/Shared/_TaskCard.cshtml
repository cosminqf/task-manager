@model TaskManager.Models.ProjectTask

@{
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var isAssigned = Model.AssignedUserId == currentUserId;
    var daysUntilDue = (Model.EndDate - DateTime.Now).Days;
    var isUrgent = daysUntilDue <= 3 && daysUntilDue >= 0 && Model.Status != TaskManager.Models.TaskStatus.Completed;
}

<div class="card fade-in @(isUrgent ? "border-warning" : "")">
    @if (!string.IsNullOrEmpty(Model.MediaUrl))
    {
        <div style="height: 200px; overflow: hidden; background: var(--color-bg-secondary);">
            @if (Model.MediaUrl.Contains("youtube.com") || Model.MediaUrl.Contains("youtu.be") || Model.MediaUrl.Contains("vimeo.com"))
            {
                <div class="ratio ratio-16x9">
                    <iframe src="@Model.MediaUrl" allowfullscreen style="border: none;"></iframe>
                </div>
            }
            else if (Model.MediaUrl.StartsWith("/") || Model.MediaUrl.StartsWith("http"))
            {
                <img src="@Model.MediaUrl" alt="@Model.Title" style="width: 100%; height: 100%; object-fit: cover;" 
                     onerror="this.parentElement.style.display='none'" />
            }
        </div>
    }
    
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-start mb-md">
            <h5 class="card-title mb-0 flex-grow-1">
                <a asp-action="Show" asp-controller="Tasks" asp-route-id="@Model.Id" class="text-decoration-none text-dark">
                    @Model.Title
                </a>
            </h5>
            <partial name="_StatusBadge" model="Model.Status" />
        </div>
        
        @if (!string.IsNullOrEmpty(Model.Description))
        {
            <p class="text-muted mb-md small">
                @(Model.Description?.Length > 100 
                    ? Model.Description.Substring(0, 100) + "..." 
                    : Model.Description)
            </p>
        }
        
        <div class="d-flex justify-content-between align-items-center mb-md" style="font-size: var(--font-size-sm);">
            <span class="text-muted">
                <i class="bi bi-calendar-event"></i> @Model.StartDate.ToString("dd MMM")
            </span>
            <span class="@(isUrgent ? "text-warning fw-bold" : "text-muted")">
                <i class="bi bi-flag"></i> @Model.EndDate.ToString("dd MMM yyyy")
                @if (isUrgent)
                {
                    <span class="badge badge-warning ms-1">@daysUntilDue zile</span>
                }
            </span>
        </div>
        
        @if (Model.AssignedUser != null)
        {
            <div class="chip mb-md">
                <span class="avatar avatar-sm">@(Model.AssignedUser.UserName?.Substring(0, 1).ToUpper() ?? "?")</span>
                @Model.AssignedUser.UserName
            </div>
        }
        
        <div class="d-flex gap-2">
            <a asp-action="Show" asp-controller="Tasks" asp-route-id="@Model.Id" class="btn btn-secondary btn-sm flex-grow-1">
                <i class="bi bi-eye"></i> Detalii
            </a>
            @if (isAssigned || User.IsInRole("Admin"))
            {
                <a asp-action="Edit" asp-controller="Tasks" asp-route-id="@Model.Id" class="btn btn-ghost btn-sm" title="Editează" aria-label="Editează task">
                    <i class="bi bi-pencil"></i>
                </a>
            }
        </div>
    </div>
</div>
